<!-- templates/dashboard/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasky Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/1.0.6/heroicons.min.css" integrity="sha512-wyrIS7Jk/C9DlzhQ8UUPk7axR8V2D/zi35Eci6Eu71ngTMiMsqLQqDRx/mshfF/9Kg9pVSR9WYh+zw0YP29hFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body class="bg-blue-100">
    <div class="flex flex-col md:flex-row min-h-screen">
        {% load static %}

        <!-- Include the sidebar -->
        {% include 'includes/sidebar.html' %}

        <!-- Main Content -->
        <main class="flex-1 p-6">
            {% if messages %}
                <ul>
                    {% for message in messages %}
                        <li>{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <!-- Header -->
            <header class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-4 sm:space-y-0">
                <div class="flex items-center w-full sm:w-auto">
                    <form action="{% url 'dashboard' %}" method="get" class="w-full">
                        <div class="flex">
                            <input type="text" name="query" placeholder="Search tasks" 
                            class="flex-grow p-2 border rounded-l-md" value="{{ query }}">
                            <button type="submit" class="p-2 bg-blue-400 text-white rounded-r-md">Search</button>
                        </div>
                    </form>
                </div>
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 14l-3 6V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12l-3-6H3z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405C18.382 14.79 18 13.453 18 12V8a6 6 0 10-12 0v4c0 1.453-.382 2.79-1.595 3.595L3 17h5m7 0a3 3 0 01-6 0m6 0H9" />
                    </svg>

                    <a>
                        <img src="{% static 'img/avatar-1.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full">
                    </a>
                    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">
                        {% csrf_token %}
                    </form>
                    <a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 13V11H8V7L3 12L8 17V13H16Z" fill="currentColor"/>
                            <path d="M13 2H21C21.5523 2 22 2.44772 22 3V21C22 21.5523 21.5523 22 21 22H13C12.4477 22 12 21.5523 12 21V15H14V20H20V4H14V9H12V3C12 2.44772 12.4477 2 13 2Z" fill="currentColor"/>
                        </svg>
                    </a>
                </div>
            </header>

            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">

                    <form class="flex" action="{% url 'dashboard' %}" method="get">
                        <select name="priority" class="form-control">
                            <option value="">-- Select Priority --</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                        <input class="form-control" type="date" name="due_date" value="{{ due_date|date:'Y-m-d' }}">
                        <input class="form-control" type="text" name="category" value="{{ category }}" placeholder="Category...">
                        <button type="submit" class="ml-n1 p-2 bg-blue-400 text-white rounded-md">Search</button>
                    </form>
                </div>
                <div class="flex items-center">
                    <div class="flex">
                        <img src="{% static 'img/avatar-1.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full">
                        <img src="{% static 'img/avatar-2.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                        <img src="{% static 'img/avatar-3.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                    </div>
                    <span class="ml-n2">
                        <span class="inline-flex items-center justify-center h-5 w-5 rounded-full bg-blue-500 text-white">+2</span>
                    </span>
                    <button id="addTaskBtn" class="ml-6 p-2 bg-blue-500 text-white rounded-md">+ Add task</button>
                </div>
            </div>

            <!-- Task Boards -->
            <div class="grid grid-cols-3 gap-6">

                <!-- In Progress Column -->
                <div>
                    <h2 class="text-lg font-semibold mb-4">In Progress
                        <span class="small"> ({{ in_progress_counter }}) </span> 
                    </h2>
                    <!-- Task Card -->
                    {% for task in in_progress_tasks %}

                        <div
                            id="inProgressColumn"
                            class="bg-white p-4 my-6 rounded-lg shadow task-card status-column cursor-pointer"
                            draggable="true" data-task-id="{{ task.id }}">
                            <div class="bg-gray-100 flex flex-wrap justify-between items-center mb-2 p-2 rounded-md">
                                <span class="text-xs bg-red-100 text-red-500 py-1 px-2 rounded w-full sm:w-auto mb-2 sm:mb-0">{{ task.priority }}</span>
                                <span class="text-xs bg-purple-100 text-purple-500 py-1 px-2 rounded w-full sm:w-auto mb-2 sm:mb-0">
                                    {{ task.due_date | date:"Y-m-d" }}
                                </span>
                                <span class="text-xs bg-blue-100 text-blue-500 py-1 px-2 rounded w-full sm:w-auto">{{ task.category }}</span>
                            </div>

                            <div>
                                <h3 class="text-md font-medium mb-2">{{ task.title }}</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    {{ task.description }}
                                </p>
                                <div class="flex items-center justify-between">
                                    <div class="flex">
                                        <img src="{% static 'img/avatar-1.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full">
                                        <img src="{% static 'img/avatar-2.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                                        <img src="{% static 'img/avatar-3.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                                    </div>
                                    <div class="flex">
                                        <svg data-toggle="modal" data-target="#viewTaskModal" data-id="{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="view-task-btn cursor-pointer w-4 h-4 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm1 0a4 4 0 11-8 0 4 4 0 018 0zm6-1.95C20.467 7.3 17.398 5 12 5S3.533 7.3 2 10.05a2 2 0 000 3.9C3.533 16.7 6.602 19 12 19s8.467-2.3 10-5.05a2 2 0 000-3.9z"/>
                                        </svg>
                                        <!-- update button -->
                                        <svg  data-toggle="modal" data-target="#updateTaskModal{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="cursor-pointer w-4 h-4 mx-2 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232a2.828 2.828 0 113.536 3.536L7 20.536 3 21l.464-4L15.232 5.232z"/>
                                        </svg>
                                        <svg data-toggle="modal" data-target="#deleteTaskModal{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="cursor-pointer w-4 h-4 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L6 7M6 7h12m-6 0V5m4 0H8m10 2v11c0 1.104-.896 2-2 2H8c-1.104 0-2-.896-2-2V7m10 0h-4m4 0V5a2 2 0 00-2-2H8a2 2 0 00-2 2v2z"/>
                                        </svg>

                                    </div>
                                </div>
                            </div>
                        </div>

                        {% include 'includes/task_column_modal.html' %}

                    {% endfor %}
                </div>

                <!-- Completed Column -->
                <div>
                    <h2 class="text-lg font-semibold mb-4">
                        Completed
                        <span class="small"> ({{ completed_counter }}) </span>
                    </h2>
                    <!-- Task Card -->
                    {% for task in completed_tasks %}

                        <div class="task-card status-column cursor-pointer bg-white p-4 my-6 rounded-lg shadow"
                            draggable="true" data-task-id="{{ task.id }}"
                            id="completedColumn">
                            <div class="bg-gray-100 flex flex-wrap justify-between items-center mb-2 p-2 rounded-md">
                                <span class="text-xs bg-red-100 text-red-500 py-1 px-2 rounded w-full sm:w-auto mb-2 sm:mb-0">{{ task.priority }}</span>
                                <span class="text-xs bg-purple-100 text-purple-500 py-1 px-2 rounded w-full sm:w-auto mb-2 sm:mb-0">
                                    {{ task.due_date | date:"Y-m-d" }}
                                </span>
                                <span class="text-xs bg-blue-100 text-blue-500 py-1 px-2 rounded w-full sm:w-auto">{{ task.category }}</span>
                            </div>
                            <div>
                                <h3 class="text-md font-medium mb-2">{{ task.title }}</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    {{ task.description }}
                                </p>
                                <div class="flex items-center justify-between">
                                    <div class="flex">
                                        <img src="{% static 'img/avatar-1.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full">
                                        <img src="{% static 'img/avatar-2.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                                        <img src="{% static 'img/avatar-3.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                                    </div>
                                    <div class="flex">
                                        <svg data-toggle="modal" data-target="#viewTaskModal" data-id="{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="view-task-btn cursor-pointer w-4 h-4 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm1 0a4 4 0 11-8 0 4 4 0 018 0zm6-1.95C20.467 7.3 17.398 5 12 5S3.533 7.3 2 10.05a2 2 0 000 3.9C3.533 16.7 6.602 19 12 19s8.467-2.3 10-5.05a2 2 0 000-3.9z"/>
                                        </svg>
                                        <!-- update button -->
                                        <svg  data-toggle="modal" data-target="#updateTaskModal{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="cursor-pointer w-4 h-4 mx-2 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232a2.828 2.828 0 113.536 3.536L7 20.536 3 21l.464-4L15.232 5.232z"/>
                                        </svg>
                                        <svg data-toggle="modal" data-target="#deleteTaskModal{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="cursor-pointer w-4 h-4 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L6 7M6 7h12m-6 0V5m4 0H8m10 2v11c0 1.104-.896 2-2 2H8c-1.104 0-2-.896-2-2V7m10 0h-4m4 0V5a2 2 0 00-2-2H8a2 2 0 00-2 2v2z"/>
                                        </svg>

                                    </div>
                                </div>
                            </div>
                        </div>

                        {% include 'includes/task_column_modal.html' %}

                    {% endfor %}
                </div>

                <!-- Overdue Column -->
                <div>
                    <h2 class="text-lg font-semibold mb-4">
                        Over-due
                        <span class="small"> ({{ overdue_counter }}) </span>
                    </h2>
                    <!-- Task Card -->
                    {% for task in overdue_tasks %}

                        <div class="task-card status-column cursor-pointer bg-white p-4 my-6 rounded-lg shadow"
                            draggable="true" data-task-id="{{ task.id }}"
                            id="overdueColumn">
                            <div class="bg-gray-100 flex flex-wrap justify-between items-center mb-2 p-2 rounded-md">
                                <span class="text-xs bg-red-100 text-red-500 py-1 px-2 rounded w-full sm:w-auto mb-2 sm:mb-0">{{ task.priority }}</span>
                                <span class="text-xs bg-purple-100 text-purple-500 py-1 px-2 rounded w-full sm:w-auto mb-2 sm:mb-0">
                                    {{ task.due_date | date:"Y-m-d" }}
                                </span>
                                <span class="text-xs bg-blue-100 text-blue-500 py-1 px-2 rounded w-full sm:w-auto">{{ task.category }}</span>
                            </div>
                            <div>
                                <h3 class="text-md font-medium mb-2">{{ task.title }}</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    {{ task.description }}
                                </p>
                                <div class="flex items-center justify-between">
                                    <div class="flex">
                                        <img src="{% static 'img/avatar-1.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full">
                                        <img src="{% static 'img/avatar-2.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                                        <img src="{% static 'img/avatar-3.svg' %}" alt="Avatar" class="w-6 h-6 rounded-full -ml-2">
                                    </div>
                                    <div class="flex">
                                        <svg data-toggle="modal" data-target="#viewTaskModal" data-id="{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="view-task-btn cursor-pointer w-4 h-4 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm1 0a4 4 0 11-8 0 4 4 0 018 0zm6-1.95C20.467 7.3 17.398 5 12 5S3.533 7.3 2 10.05a2 2 0 000 3.9C3.533 16.7 6.602 19 12 19s8.467-2.3 10-5.05a2 2 0 000-3.9z"/>
                                        </svg>
                                        <!-- update button -->
                                        <svg  data-toggle="modal" data-target="#updateTaskModal{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="cursor-pointer w-4 h-4 mx-2 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232a2.828 2.828 0 113.536 3.536L7 20.536 3 21l.464-4L15.232 5.232z"/>
                                        </svg>
                                        <svg data-toggle="modal" data-target="#deleteTaskModal{{ task.id }}"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="cursor-pointer w-4 h-4 text-gray-500 hover:text-gray-700">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L6 7M6 7h12m-6 0V5m4 0H8m10 2v11c0 1.104-.896 2-2 2H8c-1.104 0-2-.896-2-2V7m10 0h-4m4 0V5a2 2 0 00-2-2H8a2 2 0 00-2 2v2z"/>
                                        </svg>

                                    </div>
                                </div>
                            </div>
                        </div>

                        {% include 'includes/task_column_modal.html' %}

                    {% endfor %}
                </div>

            </div>

            <!-- Add Task Modal -->
            <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addTaskModalLabel">Add Task</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="addTaskForm" method="POST" action="{% url 'create_task' %}">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="taskNameInput">Task Name</label>
                                    <input type="text" class="form-control" id="taskNameInput" name="title" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskDescriptionInput">Description</label>
                                    <textarea class="form-control" id="taskDescriptionInput" name="description" rows="3" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="taskStatusInput">Status</label>
                                    <select class="form-control" id="taskStatusInput" name="status" required>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Overdue">Overdue</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskPriorityInput">Priority</label>
                                    <select class="form-control" id="taskPriorityInput" name="priority" required>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskDueDateInput">Due Date</label>
                                    <input type="datetime-local" class="form-control" id="taskDueDateInput" name="due_date" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskCategoryInput">Category</label>
                                    <input type="text" class="form-control" id="taskCategoryInput" name="category" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskAssignedToInput">Assigned To</label>
                                    <select class="form-control" id="taskAssignedToInput" name="assigned_to" required>
                                        {% for user in users %}
                                            <option value="{{ user.id }}">{{ user.username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">Add Task</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

        <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function() {

            $('#addTaskBtn').on('click', function() {
                $('#addTaskModal').modal('show');
            });

            $('.task-card').on('dragstart', function(event) {
                event.originalEvent.dataTransfer.setData('text/plain', $(this).data('task-id'));
            });

            $('.status-column').on('dragover', function(event) {
                event.preventDefault();
            });

            $('.status-column').on('drop', function(event) {
                var taskId = event.originalEvent.dataTransfer.getData('text/plain');
                var newStatus = $(this).attr('id'); // Get the ID of the drop zone (e.g., 'inProgressColumn')
                moveTask(taskId, newStatus); // Implement this function to update task status
            });

            // Function to move task to new status
            function moveTask(taskId, newStatus) {

                var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
                $.ajax({
                    url: 'move-tasks/' + taskId + '/',
                    type: 'POST',
                    data: {
                        new_status: newStatus,
                        id: taskId,
                        csrfmiddlewaretoken: csrfToken,
                     },
                    success: function(response) {
                        console.log('Task moved successfully:', response);
                        location.reload();
                    },
                    error: function(error) {
                        console.error('Error moving task:', error);
                    }
                });
            }

            // Adding task
            $('#addTaskForm').on('submit', function(e) {
                e.preventDefault();
                var formData = $(this).serialize();
                $.ajax({
                    type: 'POST',
                    url: $(this).attr('action'),
                    data: formData,
                    success: function(response) {
                        console.log('Task added successfully:', response);
                        $('#addTaskModal').modal('hide');
                        location.reload();
                    },
                    error: function(error) {
                        console.error('Error adding task:', error);
                    }
                });
            });

            $('.view-task-btn').on('click', function() {
                var taskId = $(this).data('id');

                $.ajax({
                    url: 'tasks/' + taskId + '/detail/',
                    method: 'GET',
                    success: function(data) {
                        $('#taskTitle').text(data.title);
                        $('#taskDescription').text(data.description);
                        $('#taskStatus').text(data.status);
                        $('#taskPriority').text(data.priority);
                        $('#taskDueDate').text(data.due_date);
                        $('#taskAssignedTo').text(data.assigned_to);
                    },
                    error: function(error) {
                        console.error('Error fetching task data:', error);
                    }
                });
            });

            $('#searchTasks').on('input', function() {
                var query = $(this).val().trim();
                $.ajax({
                    url: '{% url 'search_tasks' %}',
                    method: 'GET',
                    data: {
                        'query': query
                    },
                    success: function(data) {
                        // Replace the task boards with the updated data
                        console.log(data)
                    },
                    error: function(error) {
                        console.error('Error searching tasks:', error);
                    }
                });
            });
        });
    </script>
</body>
</html>
